#!/bin/sh
# x.PreProc_Transform

#Transforms from one image space to another e.g. from T1 to functional space, or GM-mask to functional space

if [ $# -ne 5 ]
then
    echo "********************************************************************************************************"
    echo "Insufficient arguments supplied"
    echo "Input 1 should be the full path to the input scan* "
    echo "Input 2 should be the full path to ref scan* "
    echo "Input 3 should be the full path to the transformation matrix*"
    echo "Input 4 should be the full path the output directory"
    echo "Input 5 should be output label e.g. lowres or T1toFunc"
    echo "*Note: do not include file extension - assumes nii.gz and .mat"
    echo "********************************************************************************************************"
    exit
fi

#define inputs
input_file=${1}
input_file_ref=${2}
matrix=${3}
output_dir=${4}
output_prefix=${5}

#Check the input files exist
echo "*******************************************************"
echo "Input files are ${input_file} and ${input_file_ref} and ${matrix}"
echo "*******************************************************"
if [ ! -f "${input_file}.nii.gz" ]
then
  echo "***************************************************"
  echo "Cannot locate the NIFTI input file ${input_file}"
  echo "...exiting!"
  echo "***************************************************"
  exit
fi

if [ ! -f "${input_file_ref}.nii.gz" ]
then
  echo "***************************************************"
  echo "Cannot locate the NIFTI input file ${input_file_ref}"
  echo "...exiting!"
  echo "***************************************************"
  exit
fi

if [ ! -f "${matrix}.mat" ]
then
  echo "***************************************************"
  echo "Cannot locate the matrix input file ${matrix}"
  echo "...exiting!"
  echo "***************************************************"
  exit
fi

#If output directory is not present, make it
if [ ! -d ${output_dir} ]
then
  mkdir ${output_dir}
fi
echo "********************************"
echo "Output directory is ${output_dir}"
echo "********************************"

#Get the input filename without the path
input_file_prefix="$(basename -- $input_file)"
mat_file_prefix="$(basename -- $matrix)"

#Transformation

if [ ! -f "${output_dir}/${input_file_prefix}_${output_prefix}.nii.gz" ]
then
  echo "*****************************************************"
  echo "Transforming ${input_file} to ${input_file_ref} space"
  echo "******************************************************"
  flirt -in ${input_file}.nii.gz -ref ${input_file_ref}.nii.gz -applyxfm -init "${matrix}.mat" -out "${output_dir}/${input_file_prefix}_${output_prefix}.nii.gz" -dof 6
else
   echo "***************************************************************"
   echo "${input_file} already transformed to to ${input_file_ref} space"
   echo "***************************************************************"
fi
